<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xsyx.dao.RoleDao">




    <!-- resultMap映射 -->
    <resultMap id="RoleMap" type="Role">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="remark" property="remark"/>
        <result column="has_emp_count" property="hasEmpCount"/>
    </resultMap>

    <!-- 查询所有方法 -->
    <select id="queryAll" resultMap="RoleMap">
       select name,remark,id from role where id != 1;
    </select>

    <!-- 根据主键id查询数据方法 -->
    <select id="queryById" parameterType="int" resultMap="RoleMap">
       select name,remark,id from role where id = #{id};
    </select>

    <!-- 根据Role条件查询数据方法 -->
    <select id="query" resultMap="RoleMap">
        select name,remark,id 
        from role 
        <where>
            <if test="id != null"> and id = #{id}</if>
            <if test="name != null"> and name = #{name}</if>
            <if test="remark != null"> and remark = #{remark}</if>
            and id != 1
        </where>
    </select>

    <!-- 根据Role插入数据方法 -->
    <insert id="insert" parameterType="Role" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
        insert into role (id,name,remark) values 
        (
            #{id},
            #{name},
            #{remark}
        ); 
    </insert>

    <!-- 根据Role插入多条数据方法 -->
    <insert id="inserts" parameterType="List" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
        insert into role (id,name,remark) values 
        <foreach collection="roles" item="item" separator=",">
            (
                #{item.id},
                #{item.name},
                #{item.remark}
            ) 
        </foreach>
    </insert>

    <!-- 根据Role条件修改单条数据方法,从传入对象获取主键id -->
    <update id="updateById" parameterType="Role">
        update role 
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="remark != null">remark = #{remark},</if>
        </set>
        where id = #{id}
    </update>


    <!-- 根据角色id查询所有拥有该角色的员工姓名 -->
    <select id="queryEmpNames" resultType="java.lang.String" parameterType="int">
        select el.name from employee el
        left join emprole e on el.id = e.employee
        where e.role = #{id}
    </select>

    <!-- 根据id删除角色 -->
    <delete id="delete" parameterType="int">
        delete from role where id = #{id}
    </delete>

    <!-- 根据Role条件模糊查询数据方法 -->
    <select id="queryLike" resultMap="RoleMap">
        select r.*,count(e2.id) has_emp_count from role r
        left join emprole e on r.id = e.role
        left join employee e2 on e.employee = e2.id
        where (
            <if test="name != null">r.name like concat('%',#{name},'%')</if>
            <if test="remark != null">or r.remark like concat('%',#{remark},'%')</if>
        ) and r.id!=1
        group by r.id
        order by r.id desc
    </select>

    <resultMap id="MenuMap" type="Menu">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="icon" property="icon"/>
        <result column="url" property="url"/>
        <result column="layer" property="layer"/>
        <result column="type" property="type"/>
        <association property="parent" column="{fk=parent}"
                     select="com.xsyx.dao.MenuDao.a_Menu_By_parent" javaType="Menu" fetchType="lazy"/>
    </resultMap>

    <!-- 根据角色id获取该员工的所有菜单按钮 -->
    <select id="queryMenus" resultMap="MenuMap">
        select distinct m.* from menu m
        left join permission p on m.id = p.menu
        where m.layer=3 and
              (1 in (select distinct ro.id from role ro
              where ro.id=#{id}))
           or
            (p.role in (
            select distinct ro.id from role ro
            where ro.id=#{id})
            );
    </select>

    <!-- 判断员工是否是超级管理员 -->
    <select id="isSuperAdmin" resultType="int">
        select ifnull(1 in (select role.id from role
            left join emprole e on role.id = e.role
            right join employee e2 on e.employee = e2.id
        where e2.id = #{id}),0)
    </select>

    <!-- 根据Role条件模糊查询数据方法 -->
    <select id="queryHaveLike" resultMap="RoleMap">
        select role.* from role
        left join emprole e on role.id = e.role
        right join employee e2 on e.employee = e2.id
        where e2.id = #{empId} and
            (
                <if test="role.name != null">role.name like concat('%',#{role.name},'%')</if>
                <if test="role.remark != null">or role.remark like concat('%',#{role.remark},'%')</if>
        ) and role.id!=1
        group by role.id
        order by role.id desc
    </select>

</mapper>